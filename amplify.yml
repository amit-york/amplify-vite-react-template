version: 1

backend:
  phases:
    build:
      commands:
        - echo "Starting backend build..."
        - npm ci --cache .npm --prefer-offline
        - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID

frontend:
  phases:
    preBuild:
      commands:
        - echo "Installing dependencies..."
        - npm ci --cache .npm --prefer-offline
    build:
      commands:
        - VERSION=$(git describe --tags --abbrev=0 || echo "no-tag")
        - RELEASE_DATE=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
        # âœ… Safely create build_info.json (multi-line syntax avoids YAML parsing issues)
        - |
          printf '{"version": "%s", "releaseDate": "%s"}' "$VERSION" "$RELEASE_DATE" > build_info.json
        - echo "ðŸ“¦ Build Info:"
        - cat build_info.json
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
      - ../build_info.json
  cache:
    paths:
      - .npm/**/*
      - node_modules/**/*
