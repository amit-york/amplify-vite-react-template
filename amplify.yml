# version: 1
# frontend:
#   phases:
#     preBuild:
#       commands:
#         - echo "Installing dependencies..."
#         - npm i
#         - echo "Fetching all Git tags for release info..."
#         - git fetch --tags --force
#     build:
#       commands:
#         - echo "Building frontend..."
#         - npm run build
#     postBuild:
#       commands:
#         - echo "‚úÖ Build succeeded ‚Äî running custom hook to store Git tag info..."
#         - npm run my-hook
#   artifacts:
#     baseDirectory: dist
#     files:
#       - '**/*'
#   cache:
#     paths:
#       - node_modules/**/*
#       - .npm/**/*



# version: 1
# backend:
#   phases:
#     build:
#       commands:
#         - npm i
#         - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID

# frontend:
#   phases:
#     build:
#       commands:
#         - npm run build
#     postBuild:
#       commands:
#         - echo "‚úÖ Backend and frontend builds completed ‚Äî checking branch before running post hook..."
#         - |
#           if [ "$AWS_BRANCH" = "main" ]; then
#             echo "Running post hook on main branch..."
#             npm run doromatrix:watch || echo "‚ö†Ô∏è Dora script failed ‚Äî continuing build..."
#           else
#             echo "Skipping post hook (current branch: $AWS_BRANCH)"
#           fi
#   artifacts:
#     baseDirectory: dist
#     files:
#       - '**/*'
#   cache:
#     paths:
#       - .npm/**/*
#       - node_modules/**/*


####### new script
version: 1
backend:
  phases:
    build:
      commands:
        - npm i
        - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID

frontend:
  phases:
    build:
      commands:
        - npm run build
    postBuild:
      commands:
        - echo "‚úÖ Backend and frontend builds completed ‚Äî checking branch before running post hook..."
        - |
          if [ "$AWS_BRANCH" = "main" ]; then
            echo "üåç Setting environment as PROD"
            export ENVIRONMENT="prod"
          elif [ "$AWS_BRANCH" = "stage" ]; then
            echo "üåç Setting environment as STAGE"
            export ENVIRONMENT="stage"
          else
            echo "üåç Setting environment as DEV"
            export ENVIRONMENT="dev"
          fi
        - |
          if [ "$AWS_BRANCH" = "main" ]; then
            echo "üöÄ Running Dora script..."
            npm run doromatrix:watch || echo "‚ö†Ô∏è Dora script failed ‚Äî continuing build..."
          else
            echo "‚è© Skipping Dora script (current branch: $AWS_BRANCH)"
          fi
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - .npm/**/*
      - node_modules/**/*
