// scripts/dora-metrics.js
import fs from "fs";
import { execSync } from "node:child_process";
import path from "path";

const version = execSync("git describe --tags --always").toString().trim();
const commit = execSync("git rev-parse HEAD").toString().trim();
const branch = execSync("git rev-parse --abbrev-ref HEAD").toString().trim();
const releaseDate = new Date().toISOString();

console.log("ğŸ“¦ Generating DORA metrics...");
console.log({ version, commit, branch, releaseDate });

// âœ… Define config file path (now supports root or nested)
const configDir = "src/config";
const configPath = path.join(configDir, "getConfig.ts");

// ğŸ§± Ensure directory exists
if (!fs.existsSync(configDir)) {
  fs.mkdirSync(configDir, { recursive: true });
  console.log(`ğŸ“ Created missing directory: ${configDir}`);
}

// âœ… Create new config data
const newContent = `
// âš™ï¸ Auto-generated by post-deploy DORA script
// Do not edit manually â€” changes will be overwritten on next deploy

export const AppConfig = {
  version: "${version}",
  commit: "${commit}",
  branch: "${branch}",
  releaseDate: "${releaseDate}"
};

export default AppConfig;
`;

// ğŸ“ Write file safely
fs.writeFileSync(configPath, newContent);
console.log(`âœ… DORA metrics written to ${configPath}`);
